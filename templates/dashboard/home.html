{% extends 'dashboard/index.html' %}

{% block title %}GRH Smart · Tableau de bord{% endblock %}

{% block header_title %}GRH Smart · Tableau de bord{% endblock %}

{% block content %}
<div class="container mx-auto space-y-6 mt-8">

    <!-- KPIs avec vraies données -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
      {% include 'dashboard/widgets/kpi_card.html' with label="Total candidatures" value=kpis.total_candidatures.value change=kpis.total_candidatures.change change_positive=kpis.total_candidatures.positive %}
      {% include 'dashboard/widgets/kpi_card.html' with label="En revue" value=kpis.en_revue.value change=kpis.en_revue.change change_positive=kpis.en_revue.positive %}
      {% include 'dashboard/widgets/kpi_card.html' with label="Présélection" value=kpis.preselection.value change=kpis.preselection.change change_positive=kpis.preselection.positive %}
      {% include 'dashboard/widgets/kpi_card.html' with label="Taux de conversion" value=kpis.taux_conversion.value change=kpis.taux_conversion.change change_positive=kpis.taux_conversion.positive %}
      {% include 'dashboard/widgets/kpi_card.html' with label="Score moyen" value=kpis.score_moyen.value change=kpis.score_moyen.change change_positive=kpis.score_moyen.positive %}
    </section>

    <!-- CHARTS - Les données seront chargées via JavaScript -->
    <section class="grid grid-cols-12 gap-4 mb-8">
      {% include 'dashboard/widgets/chart_container.html' with title="Répartition par statut" css_classes="col-span-12 lg:col-span-5" aria_label="Diagramme circulaire des statuts" chart_type="doughnut" chart_id="status-chart" %}

      {% include 'dashboard/widgets/chart_container.html' with title="Top postes (candidatures)" css_classes="col-span-12 lg:col-span-7" aria_label="Histogramme des postes" chart_type="bar" chart_id="postes-chart" %}

      {% include 'dashboard/widgets/chart_container.html' with title="Tendance hebdomadaire" css_classes="col-span-12" height="h-72" aria_label="Courbe hebdomadaire" chart_type="line" chart_id="tendance-chart" %}
    </section>

</div>

<!-- Script pour initialiser les graphiques avec vraies données -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuration générale des graphiques
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.backgroundColor = 'rgba(139, 92, 246, 0.8)';
    Chart.defaults.borderColor = '#6366f1';
    
    // Charger les données depuis l'API
    fetch('{% url "dashboard:data-api" %}')
        .then(response => response.json())
        .then(data => {
            // Graphique statuts
            const statusCanvas = document.querySelector('[data-chart-id="status-chart"]');
            if (statusCanvas) {
                new Chart(statusCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: data.status_chart.labels,
                        datasets: [{
                            data: data.status_chart.values,
                            backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#06b6d4', '#84cc16', '#f97316'],
                            borderColor: ['#1d4ed8', '#7c3aed', '#059669', '#d97706', '#dc2626', '#0891b2', '#65a30d', '#ea580c'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            // Graphique postes
            const postesCanvas = document.querySelector('[data-chart-id="postes-chart"]');
            if (postesCanvas) {
                new Chart(postesCanvas, {
                    type: 'bar',
                    data: {
                        labels: data.postes_chart.labels,
                        datasets: [{
                            data: data.postes_chart.values,
                            backgroundColor: 'rgba(139, 92, 246, 0.8)',
                            borderColor: '#6366f1',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#334155'
                                }
                            },
                            x: {
                                grid: {
                                    color: '#334155'
                                }
                            }
                        }
                    }
                });
            }
            
            // Graphique tendance
            const tendanceCanvas = document.querySelector('[data-chart-id="tendance-chart"]');
            if (tendanceCanvas) {
                new Chart(tendanceCanvas, {
                    type: 'line',
                    data: {
                        labels: data.tendance_chart.labels,
                        datasets: [{
                            data: data.tendance_chart.values,
                            backgroundColor: 'rgba(139, 92, 246, 0.2)',
                            borderColor: '#6366f1',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#334155'
                                }
                            },
                            x: {
                                grid: {
                                    color: '#334155'
                                }
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des données:', error);
        });
});
</script>
{% endblock %}

